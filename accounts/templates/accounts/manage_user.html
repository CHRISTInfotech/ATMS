{% extends 'admin_base.html' %}
{% load static %}

{% block title %}Manage Users{% endblock %}

{% block content %}
<div class="container mt-4">

    <!-- Page Header with Font Awesome icon -->
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
        <h2 class="mb-2"><i class="fa fa-users me-2"></i>Manage Users</h2>
        <div class="input-group w-auto">
            <span class="input-group-text bg-light"><i class="fa fa-search"></i></span>
            <input id="userSearch" type="text" class="form-control" placeholder="Search Usersâ€¦">
        </div>
    </div>

    <!-- Display messages -->
    {% if messages %}
      <div class="mt-2">
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}

    {% if users %}
    <div class="card shadow-sm rounded">
        <div class="card-body p-3">
            <div class="table-responsive">
                <table class="table table-hover table-bordered align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th><i class="fa fa-envelope me-1"></i>Email</th>
                            <th><i class="fa fa-id-badge me-1"></i>Emp ID</th>
                            <th><i class="fa fa-phone me-1"></i>Phone</th>
                            <th><i class="fa fa-venus-mars me-1"></i>Gender</th>
                            <th><i class="fa fa-user-tag me-1"></i>Role</th>
                            <th><i class="fa fa-building me-1"></i>Campus</th>
                            <th><i class="fa fa-school me-1"></i>School</th>
                            <th><i class="fa fa-book me-1"></i>Department</th>
                            <th style="min-width: 180px;"><i class="fa fa-cogs me-1"></i>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="userTable">
                        {% for user in users %}
                        <tr data-user-id="{{ user.id }}">
                            <form method="POST" action="{% url 'accounts:update_user_role' user.id %}" class="d-flex align-items-center gap-2">
                                {% csrf_token %}
                                <!-- Email -->
                                <td>
                                    <span class="view-mode">{{ user.email }}</span>
                                    <input type="email" name="email" value="{{ user.email }}" 
                                           class="form-control form-control-sm edit-mode d-none">
                                </td>
                                <!-- Emp ID -->
                                <td>
                                    <span class="view-mode">{{ user.emp_id|default:"-" }}</span>
                                    <input type="text" name="emp_id" value="{{ user.emp_id|default:'' }}" 
                                           class="form-control form-control-sm edit-mode d-none">
                                </td>
                                <!-- Phone -->
                                <td>
                                    <span class="view-mode">{{ user.phone_number|default:"-" }}</span>
                                    <input type="text" name="phone_number" value="{{ user.phone_number|default:'' }}" 
                                           class="form-control form-control-sm edit-mode d-none"
                                           pattern="\d*" title="Phone must be digits only">
                                </td>
                                <!-- Gender -->
                                <td>
                                    <span class="view-mode">{{ user.gender|default:"-" }}</span>
                                    <select name="gender" class="form-select form-select-sm edit-mode d-none">
                                        <option value="" {% if not user.gender %}selected{% endif %}>-</option>
                                        <option value="Male" {% if user.gender == "Male" %}selected{% endif %}>Male</option>
                                        <option value="Female" {% if user.gender == "Female" %}selected{% endif %}>Female</option>
                                        <option value="Other" {% if user.gender == "Other" %}selected{% endif %}>Other</option>
                                    </select>
                                </td>
                                <!-- Role -->
                                <td>
                                    <span class="view-mode">{{ user.role|default:"-" }}</span>
                                    <select name="role" class="form-select form-select-sm edit-mode d-none">
                                        <option value="admin" {% if user.role == "admin" %}selected{% endif %}>Admin</option>
                                        <option value="hod" {% if user.role == "hod" %}selected{% endif %}>HOD</option>
                                        <option value="staff" {% if user.role == "staff" %}selected{% endif %}>Staff</option>
                                        <option value="student" {% if user.role == "student" %}selected{% endif %}>Student</option>
                                    </select>
                                </td>
                                <!-- Campus -->
                                <td>
                                    <span class="view-mode">{{ user.campus.name|default:"-" }}</span>
                                    <select name="campus" class="form-select form-select-sm edit-mode d-none campusSelect">
                                        <option value="">-</option>
                                        {% for campus in campuses %}
                                            <option value="{{ campus.id }}" {% if user.campus and user.campus.id == campus.id %}selected{% endif %}>
                                                {{ campus.name }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <!-- School -->
                                <td>
                                    <span class="view-mode">{{ user.school.name|default:"-" }}</span>
                                    <select name="school" class="form-select form-select-sm edit-mode d-none schoolSelect">
                                        <option value="">-</option>
                                        {% for school in schools %}
                                            <option value="{{ school.id }}" data-campus="{{ school.campus.id }}" 
                                                {% if user.school and user.school.id == school.id %}selected{% endif %}>
                                                {{ school.name }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <!-- Department -->
                                <td>
                                    <span class="view-mode">{{ user.department.name|default:"-" }}</span>
                                    <select name="department" class="form-select form-select-sm edit-mode d-none departmentSelect">
                                        <option value="">-</option>
                                        {% for dept in departments %}
                                            <option value="{{ dept.id }}" data-school="{{ dept.school.id }}" 
                                                {% if user.department and user.department.id == dept.id %}selected{% endif %}>
                                                {{ dept.name }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <!-- Actions -->
                                <td class="text-center">
                                    <div class="d-flex gap-1 justify-content-center">
                                        <button type="button" class="btn btn-primary btn-sm editBtn px-3">
                                            <i class="fa fa-edit me-1"></i> Edit
                                        </button>
                                        <button type="submit" class="btn btn-success btn-sm updateBtn px-3 d-none">
                                            <i class="fa fa-check me-1"></i> Update
                                        </button>
                                        <a href="{% url 'accounts:delete_user' user.id %}" 
                                           class="btn btn-danger btn-sm px-3"
                                           onclick="return confirm('Are you sure you want to delete this user?');">
                                           <i class="fa fa-trash me-1"></i> Delete
                                        </a>
                                    </div>
                                </td>
                            </form>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% else %}
        <p class="mt-3 text-muted">No users found.</p>
    {% endif %}

</div>

<!-- JS: Search, Edit/Update Toggle, Cascading Dropdowns -->
<script>
document.addEventListener("DOMContentLoaded", function() {

    // Search Filter
    const searchInput = document.getElementById("userSearch");
    const tableRows = document.querySelectorAll("#userTable tr");
    searchInput.addEventListener("keyup", function() {
        const value = this.value.toLowerCase();
        tableRows.forEach(row => {
            row.style.display = row.innerText.toLowerCase().includes(value) ? "" : "none";
        });
    });

    // Edit/Update Toggle
    const editBtns = document.querySelectorAll(".editBtn");
    editBtns.forEach(btn => {
        btn.addEventListener("click", function() {
            const tr = btn.closest("tr");
            tr.querySelectorAll(".view-mode").forEach(el => el.classList.add("d-none"));
            tr.querySelectorAll(".edit-mode").forEach(el => el.classList.remove("d-none"));
            tr.querySelector(".editBtn").classList.add("d-none");
            tr.querySelector(".updateBtn").classList.remove("d-none");
        });
    });

    // Cascading Dropdowns
    const rows = document.querySelectorAll("#userTable tr");
    rows.forEach(row => {
        const campusSelect = row.querySelector(".campusSelect");
        const schoolSelect = row.querySelector(".schoolSelect");
        const departmentSelect = row.querySelector(".departmentSelect");

        if (!campusSelect) return;

        const schoolOptions = Array.from(schoolSelect.options).filter(opt => opt.value !== '');
        const departmentOptions = Array.from(departmentSelect.options).filter(opt => opt.value !== '');

        campusSelect.addEventListener("change", function() {
            const campusId = this.value;
            schoolSelect.innerHTML = '';
            schoolSelect.appendChild(new Option('-', ''));
            schoolOptions.forEach(opt => {
                if (opt.dataset.campus === campusId) schoolSelect.appendChild(opt.cloneNode(true));
            });
            departmentSelect.innerHTML = '';
            departmentSelect.appendChild(new Option('-', ''));
        });

        schoolSelect.addEventListener("change", function() {
            const schoolId = this.value;
            departmentSelect.innerHTML = '';
            departmentSelect.appendChild(new Option('-', ''));
            departmentOptions.forEach(opt => {
                if (opt.dataset.school === schoolId) departmentSelect.appendChild(opt.cloneNode(true));
            });
        });
    });

});
</script>

{% endblock %}
